name: Build KernelSU Next SUSFS All (Thin LTO)

on:
  workflow_dispatch:
    inputs:
      # (Existing inputs remain unchanged)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Existing steps remain unchanged until LTO configuration

      - name: Enforce LTO Thin configuration
        run: |
          cd kernel_workspace/kernel_platform
          # Force ThinLTO in all build configurations
          find . -name "build.config*" -exec sed -i \
            -e 's/LTO=full/LTO=thin/g' \
            -e 's/LTO=none/LTO=thin/g' \
            -e 's/^LTO=.*/LTO=thin/g' {} \;
          
          # Ensure ThinLTO flags
          if ! grep -q "LTO=thin" common/build.config.gki; then
            echo -e "\n# ThinLTO Configuration\nLTO=thin" >> common/build.config.gki
          fi
          
          # Verify configuration
          echo "Current LTO configuration:"
          grep "LTO=" common/build.config.gki || true

      - name: Build kernel (ThinLTO Optimized)
        if: ${{ github.event.inputs.CPU == 'sm8650' || github.event.inputs.CPU == 'sm7675' }}
        run: |
          cd kernel_workspace
          export THINLTO_NAME_SUFFIX="-ThinLTO"
          LTO=thin ./kernel_platform/build_with_bazel.py -t ${{ github.event.inputs.CPUD }} ${{ github.event.inputs.BUILD_METHOD }}

      # Modified artifact naming with ThinLTO markers
      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_ThinLTO_KernelSU_Next_${{ env.KSUVER }}_${{ steps.feil_clean.outputs.value }}
          path: ./AnyKernel3/*
